<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>javascriptを用いた無動力滑空機の計算 | suzume blog</title>
    <meta name="description" content="九州大学でものづくり活動を行っているサークルです。" />
    <link rel="stylesheet" href="/assets/css/tailwind-output.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200..900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700&family=Zen+Kaku+Gothic+New&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700&family=WDXL+Lubrifont+TC&family=Zen+Kaku+Gothic+New&display=swap"
      rel="stylesheet"
    />
    
    <!-- MathJax v3 推奨 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['\\(', '\\)']],
          displayMath: [['$$', '$$']],
          processEscapes: true,
        },
        svg: { fontCache: 'global' },
      };
    </script>
    <script
      async
      id="MathJax-script"
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
    ></script>
    
  </head>

  <body>
    <!--
  開発用ブレイクポイント
  all(mobile):
  sm(min-width: 640px):スマホ横～
  md(min-width: 768px):タブレット
  lg(min-width: 1024px):ノートPC
  xl(min-width: 1280px):大型ディスプレイ
  2xl(min-width: 1536px):超ワイド画面
-->

<header
  class="sticky top-0 z-50 w-full border-b-2 border-[#624ba1ee] divide-gray-400 py-2 bg-white"
>
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between w-full max-w-screen-xl mx-auto"
  >
    <!-- ロゴ -->
    <a
      href="/"
      class="flex px-2 items-center justify-center md:justify-start mb-4 md:mb-0"
    >
      <!-- <div class="h-8 md:h-10 w-auto">やぱの航空・ものづくりブログ</div> -->
      <img
        src="/assets/images/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202025-10-21%2020.27.02.png"
        alt="やぱの航空・ものづくりブログ ロゴ"
        class="h-8 md:h-10 w-auto ml-2"
      />
    </a>

    <!-- ナビゲーション -->
    <nav
      class="flex flex-wrap divide-x divide-gray-400 text-center font-semibold text-sm md:text-base md:mr-2"
    >
      <a href="/" class="nav-link">Home</a>
      <a href="/posts/" class="nav-link">Posts</a>
    </nav>
  </div>
</header>


    <main class="mx-auto"><article class="article">
  <header class="mb-6 border-b border-gray-200 pb-2">
    <h1 class="text-3xl font-bold text-gray-800 mb-1">javascriptを用いた無動力滑空機の計算</h1>
    <p class="text-sm text-gray-500">2025/10/21</p>
  </header>

  <div class="prose prose-pink max-w-none"><p>javascript を用いてフリーフライト機（無動力滑空機）の運動を数値積分で解き、姿勢と位置の時間変化を求めます。MathJax を有効にしているので、式は TeX で記します。</p>

<h2 id="想定読者">想定読者</h2>

<ul>
  <li>航空工学の基礎（剛体の運動方程式、空気力係数、線形化）を理解している学部生</li>
</ul>

<h2 id="何をするか">何をするか</h2>

<ul>
  <li>6DoF（剛体の 3 平行移動＋ 3 回転）の非線形方程式を <strong>機体固定座標系</strong> で定式化</li>
  <li>縦（longitudinal）・横（lateral-directional）の<strong>小擾乱線形モデル</strong>を導出</li>
  <li>これらを <strong>JavaScript（ブラウザ/Node 両対応）</strong> の簡易オイラー/Runge–Kutta 4 次で積分する最小実装を提示</li>
</ul>

<hr />

<h1 id="前提と記号">前提と記号</h1>

<ul>
  <li>座標系
    <ul>
      <li>地表座標（慣性）: ( {X_N,Y_E,Z_D} )（北・東・下）</li>
      <li>機体固定: ( {x_b,y_b,z_b} )（右手系、(x_b) 機首方向, (z_b) 下向き）</li>
    </ul>
  </li>
  <li>状態量
[
\mathbf{x}=
\begin{bmatrix}
u&amp;v&amp;w&amp;p&amp;q&amp;r&amp;\phi&amp;\theta&amp;\psi&amp;X&amp;Y&amp;Z
\end{bmatrix}^\top
]
速度 ((u,v,w))、角速度 ((p,q,r))、オイラー角 ((\phi,\theta,\psi))、位置 ((X,Y,Z))</li>
  <li>慣性モーメント行列（対称機体仮定）
[
\mathbf{J}=\begin{bmatrix}
J<em>x&amp;0&amp;-J</em>{xz}<br />
0&amp;J<em>y&amp;0<br />
-J</em>{xz}&amp;0&amp;J_z
\end{bmatrix}
]</li>
  <li>
    <p>動圧 (q_\infty=\tfrac12\rho V^2)、翼面積 (S)、翼幅 (b)、翼弦 (c)、迎角 (\alpha=\arctan(w/u))、横滑り角 (\beta=\arcsin(v/V))、(V=\sqrt{u^2+v^2+w^2})</p>
  </li>
  <li>
    <p>空気力・モーメント係数（例）
[
\begin{aligned}
C<em>L &amp;= C</em>{L0}+C<em>{L\alpha}\alpha+C</em>{L<em>q}\frac{qc}{2V}+C</em>{L<em>{\delta_e}}\delta_e<br />
C_D &amp;= C</em>{D0}+k C<em>L^2<br />
C_Y &amp;= C</em>{Y<em>\beta}\beta+C</em>{Y<em>p}\frac{pb}{2V}+C</em>{Y<em>r}\frac{rb}{2V}+C</em>{Y<em>{\delta_r}}\delta_r<br />
C_l &amp;= C</em>{l<em>\beta}\beta+C</em>{l<em>p}\frac{pb}{2V}+C</em>{l<em>r}\frac{rb}{2V}+C</em>{l<em>{\delta_a}}\delta_a<br />
C_m &amp;= C</em>{m0}+C<em>{m</em>\alpha}\alpha+C<em>{m_q}\frac{qc}{2V}+C</em>{m<em>{\delta_e}}\delta_e<br />
C_n &amp;= C</em>{n<em>\beta}\beta+C</em>{n<em>p}\frac{pb}{2V}+C</em>{n<em>r}\frac{rb}{2V}+C</em>{n_{\delta_r}}\delta_r
\end{aligned}
]</p>
  </li>
  <li>空力力（機体固定）<br />
[
\begin{aligned}
L&amp;=q<em>\infty S C_L,\quad D=q</em>\infty S C<em>D,\quad Y=q</em>\infty S C_Y<br />
\text{風軸}\to\text{機体軸変換より}\quad
\mathbf{F}_a&amp;=
\begin{bmatrix}
-D\cos\alpha+L\sin\alpha<br />
Y<br />
-D\sin\alpha-L\cos\alpha
\end{bmatrix}
\end{aligned}
]</li>
  <li>重力（機体軸成分）
[
\mathbf{F}_g=m g
\begin{bmatrix}
-\sin\theta<br />
\sin\phi\cos\theta<br />
\cos\phi\cos\theta
\end{bmatrix}
]</li>
  <li>空力モーメント
[
\mathbf{M}<em>a=
\begin{bmatrix}
q</em>\infty S b\, C<em>l<br />
q</em>\infty S c\, C<em>m<br />
q</em>\infty S b\, C_n
\end{bmatrix}
]</li>
</ul>

<hr />

<h1 id="非線形-6dof-運動方程式">非線形 6DoF 運動方程式</h1>

<h2 id="並進機体軸">並進（機体軸）</h2>

<p>[
\begin{aligned}
m(\dot{u}+qw-rv) &amp;= F<em>{ax}+F</em>{gx}<br />
m(\dot{v}+ru-pw) &amp;= F<em>{ay}+F</em>{gy}<br />
m(\dot{w}+pv-qu) &amp;= F<em>{az}+F</em>{gz}
\end{aligned}
]</p>

<h2 id="回転機体軸">回転（機体軸）</h2>

<p>[
\mathbf{J}\dot{\boldsymbol{\omega}}+\boldsymbol{\omega}\times(\mathbf{J}\boldsymbol{\omega})=\mathbf{M}_a
\quad(\boldsymbol{\omega}=[p,q,r]^\top)
]</p>

<h2 id="キネマティクスオイラー角">キネマティクス（オイラー角）</h2>

<p>[
\begin{bmatrix}
\dot{\phi}\\dot{\theta}\\dot{\psi}
\end{bmatrix}=
\begin{bmatrix}
1 &amp; \sin\phi\tan\theta &amp; \cos\phi\tan\theta<br />
0 &amp; \cos\phi &amp; -\sin\phi<br />
0 &amp; \sin\phi/\cos\theta &amp; \cos\phi/\cos\theta
\end{bmatrix}
\begin{bmatrix}
p\q\r
\end{bmatrix}
]</p>

<h2 id="位置">位置</h2>

<p>[
\begin{bmatrix}\dot{X}\\dot{Y}\\dot{Z}\end{bmatrix}
=\mathbf{R}<em>{b\to n}(\phi,\theta,\psi)
\begin{bmatrix}u\v\w\end{bmatrix}
]
（(\mathbf{R}</em>{b\to n}) は機体 → 慣性の回転行列）</p>

<hr />

<h1 id="縦の運動方程式longitudinal">縦の運動方程式（longitudinal）</h1>

<p>小擾乱（定常滑空点 ((U<em>0,0,W_0,\dots)) まわり）で、横滑り・ロールを無視すると
[
\delta\mathbf{x}</em>\text{lon}=
\begin{bmatrix}\delta u&amp;\delta w&amp;\delta q&amp;\delta\theta\end{bmatrix}^\top,\quad
\delta\mathbf{u}<em>\text{lon}=\begin{bmatrix}\delta\delta_e\end{bmatrix}
]
線形化により
[
\dot{\delta\mathbf{x}}</em>\text{lon}=\mathbf{A}<em>\text{lon}\,\delta\mathbf{x}</em>\text{lon}+\mathbf{B}<em>\text{lon}\,\delta\mathbf{u}</em>\text{lon}
]
[
\mathbf{A}<em>\text{lon}=
\begin{bmatrix}
X_u/m &amp; X_w/m &amp; 0 &amp; -g\cos\theta_0<br />
Z_u/(m-U_0 Z</em>{\dot{w}}) &amp; Z<em>w/(m-U_0 Z</em>{\dot{w}}) &amp; (Z<em>q+mU_0)/(m-U_0 Z</em>{\dot{w}}) &amp; -mg\sin\theta<em>0/(m-U_0 Z</em>{\dot{w}})<br />
M<em>u/J_y &amp; M_w/J_y &amp; M_q/J_y &amp; 0<br />
0&amp;0&amp;1&amp;0
\end{bmatrix},\quad
\mathbf{B}</em>\text{lon}=
\begin{bmatrix}
X<em>{\delta_e}/m<br />
Z</em>{\delta<em>e}/(m-U_0 Z</em>{\dot{w}})<br />
M_{\delta_e}/J_y<br />
0
\end{bmatrix}
]</p>

<hr />

<h1 id="横の運動方程式lateraldirectional">横の運動方程式（lateral–directional）</h1>

<p>[
\delta\mathbf{x}<em>\text{lat}=
\begin{bmatrix}\delta v&amp;\delta p&amp;\delta r&amp;\delta\phi&amp;\delta\psi\end{bmatrix}^\top,\quad
\delta\mathbf{u}</em>\text{lat}=\begin{bmatrix}\delta\delta<em>a&amp;\delta\delta_r\end{bmatrix}^\top
]
[
\dot{\delta\mathbf{x}}</em>\text{lat}=\mathbf{A}<em>\text{lat}\,\delta\mathbf{x}</em>\text{lat}+\mathbf{B}<em>\text{lat}\,\delta\mathbf{u}</em>\text{lat}
]</p>

<hr />

<h1 id="javascript-による数値積分最小実装">JavaScript による数値積分（最小実装）</h1>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 6DoF glider simulator (minimal, browser/Node)</span>
<span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="mf">9.80665</span><span class="p">;</span>

<span class="kd">function</span> <span class="nf">skew</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">w</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">w</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">w</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="nx">w</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">mul3</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="nx">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="nx">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="nx">A</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">A</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
  <span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">Rb2n</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">,</span> <span class="nx">psi</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cφ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">phi</span><span class="p">),</span>
    <span class="nx">sφ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">cθ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">),</span>
    <span class="nx">sθ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">theta</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">cψ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">psi</span><span class="p">),</span>
    <span class="nx">sψ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">psi</span><span class="p">);</span>
  <span class="c1">// Z(psi)Y(theta)X(phi)</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="nx">cθ</span> <span class="o">*</span> <span class="nx">cψ</span><span class="p">,</span>
    <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">sθ</span> <span class="o">*</span> <span class="nx">cψ</span> <span class="o">-</span> <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">sψ</span><span class="p">,</span>
    <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">sθ</span> <span class="o">*</span> <span class="nx">cψ</span> <span class="o">+</span> <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">sψ</span><span class="p">,</span>
    <span class="nx">cθ</span> <span class="o">*</span> <span class="nx">sψ</span><span class="p">,</span>
    <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">sθ</span> <span class="o">*</span> <span class="nx">sψ</span> <span class="o">+</span> <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">cψ</span><span class="p">,</span>
    <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">sθ</span> <span class="o">*</span> <span class="nx">sψ</span> <span class="o">-</span> <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">cψ</span><span class="p">,</span>
    <span class="o">-</span><span class="nx">sθ</span><span class="p">,</span>
    <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">cθ</span><span class="p">,</span>
    <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">cθ</span><span class="p">,</span>
  <span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">eulerRates</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cφ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">phi</span><span class="p">),</span>
    <span class="nx">sφ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">cθ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">),</span>
    <span class="nx">sθ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">theta</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">tθ</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">tan</span><span class="p">(</span><span class="nx">theta</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">p</span> <span class="o">+</span> <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">tθ</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">+</span> <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">tθ</span> <span class="o">*</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">cφ</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">-</span> <span class="nx">sφ</span> <span class="o">*</span> <span class="nx">r</span><span class="p">,</span> <span class="p">(</span><span class="nx">sφ</span> <span class="o">/</span> <span class="nx">cθ</span><span class="p">)</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">+</span> <span class="p">(</span><span class="nx">cφ</span> <span class="o">/</span> <span class="nx">cθ</span><span class="p">)</span> <span class="o">*</span> <span class="nx">r</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">aeroForcesMoments</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">rho</span><span class="p">,</span> <span class="nx">S</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">geom</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">,</span> <span class="nx">psi</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">V</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">hypot</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">w</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">qbar</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nx">rho</span> <span class="o">*</span> <span class="nx">V</span> <span class="o">*</span> <span class="nx">V</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">u</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">beta</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">asin</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">v</span> <span class="o">/</span> <span class="nx">V</span><span class="p">)));</span>

  <span class="kd">const</span> <span class="p">{</span> <span class="nx">delta_e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">delta_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">delta_r</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ctrl</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">C</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">coeffs</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">CL</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CL0</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CLa</span> <span class="o">*</span> <span class="nx">alpha</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CLq</span> <span class="o">*</span> <span class="p">((</span><span class="nx">q</span> <span class="o">*</span> <span class="nx">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CLde</span> <span class="o">*</span> <span class="nx">delta_e</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">CD</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CD0</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">k</span> <span class="o">*</span> <span class="nx">CL</span> <span class="o">*</span> <span class="nx">CL</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">CY</span> <span class="o">=</span>
    <span class="nx">C</span><span class="p">.</span><span class="nx">CYb</span> <span class="o">*</span> <span class="nx">beta</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CYp</span> <span class="o">*</span> <span class="p">((</span><span class="nx">p</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CYr</span> <span class="o">*</span> <span class="p">((</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">CYdr</span> <span class="o">*</span> <span class="nx">delta_r</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Cl</span> <span class="o">=</span>
    <span class="nx">C</span><span class="p">.</span><span class="nx">Clb</span> <span class="o">*</span> <span class="nx">beta</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Clp</span> <span class="o">*</span> <span class="p">((</span><span class="nx">p</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Clr</span> <span class="o">*</span> <span class="p">((</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Clda</span> <span class="o">*</span> <span class="nx">delta_a</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Cm</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cm0</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cma</span> <span class="o">*</span> <span class="nx">alpha</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cmq</span> <span class="o">*</span> <span class="p">((</span><span class="nx">q</span> <span class="o">*</span> <span class="nx">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cmde</span> <span class="o">*</span> <span class="nx">delta_e</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Cn</span> <span class="o">=</span>
    <span class="nx">C</span><span class="p">.</span><span class="nx">Cnb</span> <span class="o">*</span> <span class="nx">beta</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cnp</span> <span class="o">*</span> <span class="p">((</span><span class="nx">p</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cnr</span> <span class="o">*</span> <span class="p">((</span><span class="nx">r</span> <span class="o">*</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">V</span><span class="p">))</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Cndr</span> <span class="o">*</span> <span class="nx">delta_r</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">L</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">CL</span><span class="p">,</span>
    <span class="nx">D</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">CD</span><span class="p">,</span>
    <span class="nx">Y</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">CY</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">sa</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">alpha</span><span class="p">),</span>
    <span class="nx">ca</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">alpha</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">Fax</span> <span class="o">=</span> <span class="o">-</span><span class="nx">D</span> <span class="o">*</span> <span class="nx">ca</span> <span class="o">+</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">sa</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Fay</span> <span class="o">=</span> <span class="nx">Y</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Faz</span> <span class="o">=</span> <span class="o">-</span><span class="nx">D</span> <span class="o">*</span> <span class="nx">sa</span> <span class="o">-</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">ca</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">Lm</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">Cl</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Mm</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">c</span> <span class="o">*</span> <span class="nx">Cm</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Nm</span> <span class="o">=</span> <span class="nx">qbar</span> <span class="o">*</span> <span class="nx">S</span> <span class="o">*</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">Cn</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">{</span> <span class="na">F</span><span class="p">:</span> <span class="p">[</span><span class="nx">Fax</span><span class="p">,</span> <span class="nx">Fay</span><span class="p">,</span> <span class="nx">Faz</span><span class="p">],</span> <span class="na">M</span><span class="p">:</span> <span class="p">[</span><span class="nx">Lm</span><span class="p">,</span> <span class="nx">Mm</span><span class="p">,</span> <span class="nx">Nm</span><span class="p">],</span> <span class="nx">V</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">beta</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">derivs</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">ctrlFunc</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">X</span><span class="p">,</span> <span class="nx">Y</span><span class="p">,</span> <span class="nx">Z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">J</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">mass</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ctrl</span> <span class="o">=</span> <span class="nf">ctrlFunc</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">F</span><span class="p">,</span> <span class="nx">M</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">aeroForcesMoments</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">fg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="nx">m</span> <span class="o">*</span> <span class="nx">g</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">theta</span><span class="p">),</span>
    <span class="nx">m</span> <span class="o">*</span> <span class="nx">g</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">),</span>
    <span class="nx">m</span> <span class="o">*</span> <span class="nx">g</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="kd">const</span> <span class="nx">du</span> <span class="o">=</span> <span class="p">(</span><span class="nx">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">fg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">*</span> <span class="nx">v</span> <span class="o">-</span> <span class="nx">q</span> <span class="o">*</span> <span class="nx">w</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">dv</span> <span class="o">=</span> <span class="p">(</span><span class="nx">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">fg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">w</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">*</span> <span class="nx">u</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">dw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nx">fg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">q</span> <span class="o">*</span> <span class="nx">u</span> <span class="o">-</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">v</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">Jx</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">Jx</span><span class="p">,</span>
    <span class="nx">Jy</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">Jy</span><span class="p">,</span>
    <span class="nx">Jz</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">Jz</span><span class="p">,</span>
    <span class="nx">Jxz</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">Jxz</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma</span> <span class="o">=</span> <span class="nx">Jx</span> <span class="o">*</span> <span class="nx">Jz</span> <span class="o">-</span> <span class="nx">Jxz</span> <span class="o">*</span> <span class="nx">Jxz</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Jxz</span> <span class="o">*</span> <span class="p">(</span><span class="nx">Jx</span> <span class="o">-</span> <span class="nx">Jz</span> <span class="o">+</span> <span class="nx">Jy</span><span class="p">))</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Jz</span> <span class="o">*</span> <span class="p">(</span><span class="nx">Jz</span> <span class="o">-</span> <span class="nx">Jy</span><span class="p">)</span> <span class="o">+</span> <span class="nx">Jxz</span> <span class="o">*</span> <span class="nx">Jxz</span><span class="p">)</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma3</span> <span class="o">=</span> <span class="nx">Jz</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma4</span> <span class="o">=</span> <span class="nx">Jxz</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma5</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Jz</span> <span class="o">-</span> <span class="nx">Jx</span><span class="p">)</span> <span class="o">/</span> <span class="nx">Jy</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma6</span> <span class="o">=</span> <span class="nx">Jxz</span> <span class="o">/</span> <span class="nx">Jy</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma7</span> <span class="o">=</span> <span class="p">((</span><span class="nx">Jx</span> <span class="o">-</span> <span class="nx">Jy</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Jx</span> <span class="o">+</span> <span class="nx">Jxz</span> <span class="o">*</span> <span class="nx">Jxz</span><span class="p">)</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">Gamma8</span> <span class="o">=</span> <span class="nx">Jx</span> <span class="o">/</span> <span class="nx">Gamma</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">pdot</span> <span class="o">=</span> <span class="nx">Gamma3</span> <span class="o">*</span> <span class="nx">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">Gamma4</span> <span class="o">*</span> <span class="nx">M</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nx">Gamma1</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">+</span> <span class="nx">Gamma2</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">*</span> <span class="nx">r</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">qdot</span> <span class="o">=</span> <span class="p">(</span><span class="nx">M</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">Gamma5</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">r</span> <span class="o">+</span> <span class="nx">Gamma6</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">*</span> <span class="nx">r</span><span class="p">))</span> <span class="o">/</span> <span class="nx">Jy</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">rdot</span> <span class="o">=</span> <span class="nx">Gamma4</span> <span class="o">*</span> <span class="nx">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">Gamma8</span> <span class="o">*</span> <span class="nx">M</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nx">Gamma7</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">+</span> <span class="nx">Gamma1</span> <span class="o">*</span> <span class="nx">q</span> <span class="o">*</span> <span class="nx">r</span><span class="p">;</span>

  <span class="kd">const</span> <span class="p">[</span><span class="nx">phidot</span><span class="p">,</span> <span class="nx">thetadot</span><span class="p">,</span> <span class="nx">psidot</span><span class="p">]</span> <span class="o">=</span> <span class="nf">eulerRates</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">R</span> <span class="o">=</span> <span class="nc">Rb2n</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span><span class="p">,</span> <span class="nx">psi</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">Vn</span> <span class="o">=</span> <span class="nf">mul3</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span> <span class="p">[</span><span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">w</span><span class="p">]);</span> <span class="c1">// [Xdot,Ydot,Zdot]</span>

  <span class="k">return</span> <span class="p">[</span><span class="nx">du</span><span class="p">,</span> <span class="nx">dv</span><span class="p">,</span> <span class="nx">dw</span><span class="p">,</span> <span class="nx">pdot</span><span class="p">,</span> <span class="nx">qdot</span><span class="p">,</span> <span class="nx">rdot</span><span class="p">,</span> <span class="nx">phidot</span><span class="p">,</span> <span class="nx">thetadot</span><span class="p">,</span> <span class="nx">psidot</span><span class="p">,</span> <span class="nx">Vn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">Vn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">Vn</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
</article>
</main>

    <!-- <footer>
  <div class="footer">
    <div class="copy">&copy;2024 九大ロボ技</div>
  </div>
</footer> -->

<footer class="bg-[#9191a7] mt-4">
  <div class="mx-auto p-2 text-center" style="font-family: var(--font-lubri)">
    <p>© 2025 やぱの航空・ものづくりブログ</p>
  </div>
</footer>

  </body>
</html>
